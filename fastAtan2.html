<!DOCTYPE html>
<html lang="en">
<meta charset="utf-8"/>
<head>
	<title>Fast atan2</title>
</head>
<body>
	<p> 
		Activate javascript and check the console !
	</p>
</body>
<script>
function time(){
	return new Date().getTime();
}

function powerOf2(n){
	return Math.round(Math.pow(2,n));
}


function errorCheck(start,end,nSteps,trueFunction,approximateFunction){
	var x=start;
	var dx=(end-start)/nSteps;
	var absError=0;
	var relError=0;
	while (x<end){
		absError=Math.max(absError,Math.abs(trueFunction(x)-approximateFunction(x)));
		relError=Math.max(relError,Math.abs(trueFunction(x)-approximateFunction(x))
			                     /(Math.abs(trueFunction(x)+approximateFunction(x))));
		x+=dx;
	}
	console.log("max absolute error: "+absError);
}

function compare(start,end,nSteps,trueFunction,approximateFunction){
	var x=start;
	var dx=(end-start)/nSteps;
	var error=0;
	console.log("compare:  x, true function, approximation, error");
	while (x<end){
		console.log(x+" "+trueFunction(x)+" "+approximateFunction(x)+" "+(approximateFunction(x)-trueFunction(x)));
		x+=dx;
	}
}

function makeFunctionTable(length,start,delta,theFunction){
	table=new Array(length);
	for (var i = 0;i<length;i++){
		table[i]=theFunction(start+i*delta);
	}
	return table;
}

var atanTab=[];
var atanTabFactor=0;
var piHalf=0.5*Math.PI;


function setupAtanTable(n){
	atanTabFactor=n;
	atanTab=makeFunctionTable(n+1,0,1.0/atanTabFactor,Math.atan);
}

function fastAtan2(y,x){
	if (x>0){
		if (y>0) {
			if (x>y) {
				return atanTab[Math.round(y/x*atanTabFactor)];
			}
			else {
				return piHalf-atanTab[Math.round(x/y*atanTabFactor)];
			}
		}
		else {
			if (x>-y){
				return -atanTab[Math.round(-y/x*atanTabFactor)];
			}
			else {
				return -piHalf+atanTab[Math.round(-x/y*atanTabFactor)];
			}
		}
	}
	else {
		if (y>0){
			if (x<-y){
				return Math.PI-atanTab[Math.round(-y/x*atanTabFactor)];
			}
			else {
				return piHalf+atanTab[Math.round(-x/y*atanTabFactor)];
			}
		}
		else {
			if (x<y){
				return Math.PI+atanTab[Math.round(y/x*atanTabFactor)];
			}
			else {
				return -piHalf-atanTab[Math.round(x/y*atanTabFactor)];
			}
		}

	}
}


setupAtanTable(1000);

compare(-3,3,10,function(x){return Math.atan2(x,1.0)},function(x){return fastAtan2(x,1.0)});
//errorCheck(0,30,1000,Math.atan,fastAtan);




nChecks=1000000;

var x=0;
var y=0;
var range=63;
var dx=2*range/nChecks;
var start=0;
x=-range;
start=time();
while(x<range){
	y=Math.atan2(1.0,x);

	x+=dx;
}

console.log("using the atan2 function: "+(time()-start)/1000);

x=-range;
start=time();
while(x<range){
	y=fastAtan2(1.0,x);

	x+=dx;
}

console.log("using the fast atan function: "+(time()-start)/1000);



x=-range;
start=time();
while(x<range){

	x+=dx;
}

console.log("the empty loop: "+(time()-start)/1000);

x=-range;
start=time();
while(x<range){

	x+=dx;
}

console.log("the empty loop: "+(time()-start)/1000);

</script>
</html>
