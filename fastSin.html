<!DOCTYPE html>
<html lang="en">
<meta charset="utf-8"/>
<head>
	<title>Fast sin + cos</title>
</head>
<body>
	<p> 
		Activate javascript and check the console !
	</p>
</body>
<script>
function time(){
	return new Date().getTime();
}

function powerOf2(n){
	return Math.round(Math.pow(2,n));
}


function errorCheck(start,end,step,trueFunction,approximateFunction){
	var x=start;
	var error=0;
	while (x<end){
		error=Math.max(error,Math.abs(trueFunction(x)-approximateFunction(x)));
		x+=step;
	}
	console.log("max error :"+error);
}


function makeFunctionTable(length,start,delta,theFunction){
	table=new Array(length);
	for (var i = 0;i<length;i++){
		table[i]=theFunction(start+i*delta);
	}
	return table;
}

var sinTab=[];
var cosTab=[];
var sinCosTabLengthM1=0;
var sinCosTabFactor=1;
var sinCosTabHigherCorrection=0;



function setupSinCosTable(p) {
	var sinCosTabLength=powerOf2(p);
 	sinCosTabLengthM1=sinCosTabLength-1;
    sinCosTabFactor = 0.5*sinCosTabLength/Math.PI;
    sinCosTabHigherCorrection=0.25/sinCosTabFactor/sinCosTabFactor;
    sinTab=makeFunctionTable(sinCosTabLength+1,0,1.0/sinCosTabFactor,Math.sin);
    cosTab=makeFunctionTable(sinCosTabLength,0,1.0/sinCosTabFactor,Math.cos);
}

setupSinCosTable(16);


function fastSin(x){
	return sinTab[Math.round(x*sinCosTabFactor)&sinCosTabLengthM1];
}

function fastInterpolatedSin(x){
	x*=sinCosTabFactor;
	var index=Math.floor(x);
	var dx=x-index;
	index=index&sinCosTabLengthM1;
	return sinTab[index]*(1-dx)+sinTab[index+1]*dx;
}

function fastImprovedInterpolatedSin(x){
	x*=sinCosTabFactor;
	var index=Math.floor(x);
	var dx=x-index;
	index=index&sinCosTabLengthM1;
	return sinTab[index]*(1-dx)*(1+sinCosTabHigherCorrection*dx)+sinTab[index+1]*dx*(1+sinCosTabHigherCorrection*(1-dx));
}

function fastCos(x){
	return cosTab[Math.round(x*sinCosTabFactor)&sinCosTabLengthM1];
}
/*
for (var i=-10;i<10;i++){
	x=i*0.3;
	console.log("exact, lookup "+Math.cos(x)+" "+fastCos(x));
}
*/


console.log("fast sinus approximation error: ");
errorCheck(-20,20,0.1,Math.sin,fastSin);

console.log("interpolated sinus approximation error: ");
errorCheck(-10,20,0.1,Math.sin,fastInterpolatedSin);
console.log("improved interpolated sinus approximation error: ");
errorCheck(-10,20,0.1,Math.sin,fastImprovedInterpolatedSin);
console.log("cosinus approximation error: ");
errorCheck(-10,20,0.1,Math.cos,fastCos);

nChecks=1000000;

var x=0;
var y=0;
var range=63;
var dx=range/nChecks;
var start=0;
x=0;
start=time();

while(x<range){
	y=Math.sin(x);

	x+=dx;
}
console.log("using the sin function: "+(time()-start)/1000);

x=0;
start=time();
while(x<range){
	y=fastImprovedInterpolatedSin(x);

	x+=dx;
}

console.log("using the fast improved interpolated sin function: "+(time()-start)/1000);

x=0;
start=time();
while(x<range){
	y=fastInterpolatedSin(x);

	x+=dx;
}

console.log("using the fast interpolated sin function: "+(time()-start)/1000);

x=0;
start=time();
while(x<range){
	y=fastSin(x);

	x+=dx;
}

console.log("using the fast sin function: "+(time()-start)/1000);

x=0;
start=time();
while(x<range){
	y=fastCos(x);

	x+=dx;
}

console.log("using the fast cos function: "+(time()-start)/1000);

function empty(x){
	return x;
}

x=0;
start=time();
while(x<range){
	y=empty(x);
	x+=dx;
}

console.log("the empty function: "+(time()-start)/1000);

x=0;
start=time();
while(x<range){

	x+=dx;
}

console.log("the empty loop: "+(time()-start)/1000);

</script>
</html>
