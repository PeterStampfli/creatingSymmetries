<!DOCTYPE html>
<html lang="en">
<meta charset="utf-8"/>
<head>
	<title>fastLog</title>
</head>
<body>
	<p> 
		Activate javascript and check the console !
	</p>
</body>
<script>
"use strict";
// some utilies
//==============================================================================

function time(){
	return new Date().getTime();
}

function errorCheck(start,end,step,trueFunction,approximateFunction){
	var x=start;
	var absError=0;
	var relError=0;
	var trueValue=0;
	var approximateValue=0;
	while (x<=end){
		trueValue=trueFunction(x);
		approximateValue=approximateFunction(x);
		absError=Math.max(absError,Math.abs(trueValue-approximateValue));
		relError=Math.max(relError,Math.abs(trueValue-approximateValue)/(Math.abs(trueValue)+Math.abs(approximateValue)));
		x+=step;
	}
	console.log("max absolute error: "+absError);
	console.log("max relative error: "+relError);
}

function compare(start,end,step,trueFunction,approximateFunction){
	var x=start;
	var error=0;
	console.log("compare:  x, true function, approximation, error");
	while (x<=end){
		console.log(x+" "+trueFunction(x)+" "+approximateFunction(x)+" "+(approximateFunction(x)-trueFunction(x)));
		x+=step;
	}
}

function makeFunctionTable(length,start,delta,theFunction){
	var table=new Array(length);
	for (var i = 0;i<length;i++){
		table[i]=theFunction(start+i*delta);
	}
	return table;
}


var logTab=[];
var logTabFactor=0;
function setupLogTable(n){
	logTabFactor=n;
	logTab=makeFunctionTable(n+1,1.0,1.0/logTabFactor,Math.log);
}


function fastLog(x){
	if (x<1){
		return -fastLog(1.0/x);
	}
	if (x>2147483647){
		return Math.log(x);
	}
	var divisor=1;
	var logDivisor=0;
	var remaining=Math.floor(x);
	if (remaining&0x8FFF0000){
		remaining=remaining>>16;
		divisor=divisor<<16;
		logDivisor=11.090354888959125;
	}
	if (remaining&0xFF00){
		remaining=remaining>>8;
		divisor=divisor<<8;
		logDivisor+=5.545177444479562;
	}
	if (remaining&0xF0){
		remaining=remaining>>4;
		divisor=divisor<<4;
		logDivisor+=2.772588722239781;
	}
	if (remaining&12){
		remaining=remaining>>2;
		divisor=divisor<<2;
		logDivisor+=1.3862943611198906;
	}
	if (remaining&2){
		remaining=remaining>>1;
		divisor=divisor<<1;
		logDivisor+=0.6931471805599453;
	}
	return logDivisor+logTab[Math.round(logTabFactor*(x/divisor-1.0))];
}

function fastInterpolatedLog(x){
	if (x<1){
		return -fastLog(1.0/x);
	}
	if (x>2147483647){
		return Math.log(x);
	}
	var divisor=1;
	var logDivisor=0;
	var remaining=Math.floor(x);
	if (remaining&0x8FFF0000){
		remaining=remaining>>16;
		divisor=divisor<<16;
		logDivisor=11.090354888959125;
	}
	if (remaining&0xFF00){
		remaining=remaining>>8;
		divisor=divisor<<8;
		logDivi
nChecks=10000000;

var x=0;
var y=0;
var range=63;
var dx=range/nChecks;
var start=0;
x=0;
start=time();

while(x<range){
	y=Math.sin(x);
	x+=dx;
}
console.log("using the sin function: "+(time()-start)/1000);
sor+=5.545177444479562;
	}
	if (remaining&0xF0){
		remaining=remaining>>4;
		divisor=divisor<<4;
		logDivisor+=2.772588722239781;
	}
	if (remaining&12){
		remaining=remaining>>2;
		divisor=divisor<<2;
		logDivisor+=1.3862943611198906;
	}
	if (remaining&2){
		remaining=remaining>>1;
		divisor=divisor<<1;
		logDivisor+=0.6931471805599453;
	}
	x=logTabFactor*(x/divisor-1.0);
	var index=Math.floor(x);
	x-=index;

	return logDivisor+logTab[index]*(1-x)+logTab[index+1]*x
}

setupLogTable(1000);

errorCheck(1,100,0.1,Math.log,fastLog);
errorCheck(1,100,0.1,Math.log,fastInterpolatedLog);



var nChecks=10000000;

var x=0;
var y=0;
var range=63;
var dx=range/nChecks;
var start=0.1;
x=0;
start=time();

while(x<range){
	y+=Math.log(x);
	x+=dx;
}
console.log("using the math.log function: "+(time()-start)/1000);

x=0;
start=time();

while(x<range){
	y+=fastInterpolatedLog(x);
	x+=dx;
}
console.log("fast linear interpolated: "+(time()-start)/1000);

x=0;
start=time();

while(x<range){
	y+=fastLog(x);
	x+=dx;
}
console.log("fast simple: "+(time()-start)/1000);

x=0;
start=time();

while(x<range){
	x+=dx;
}
console.log("empty loop: "+(time()-start)/1000);

</script>
</html>