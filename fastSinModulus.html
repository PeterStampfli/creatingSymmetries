<!DOCTYPE html>
<html lang="en">
<meta charset="utf-8"/>
<head>
	<title>Fast sin + cos</title>
</head>
<body>
	<p> 
		Activate javascript and check the console !
	</p>
	<p> 
		With a decent browser you can save this page on your own computer. Edit it and make your own experiments.
	</p>
</body>
<script>
// some utilies
//==============================================================================

function time(){
	return new Date().getTime();
}

function powerOf2(n){
	return Math.round(Math.pow(2,n));
}

function errorCheck(start,end,step,trueFunction,approximateFunction){
	var x=start;
	var absError=0;
	var relError=0;
	var trueValue=0;
	var approximateValue=0;
	while (x<end){
		trueValue=trueFunction(x);
		approximateValue=approximateFunction(x);
		absError=Math.max(absError,Math.abs(trueValue-approximateValue));
		x+=step;
	}
	console.log("max absolute error: "+absError);
}

function compare(start,end,step,trueFunction,approximateFunction){
	var x=start;
	var error=0;
	console.log("compare:  x, true function, approximation, error");
	while (x<end){
		console.log(x+" "+trueFunction(x)+" "+approximateFunction(x)+" "+(approximateFunction(x)-trueFunction(x)));
		x+=step;
	}
}

function makeFunctionTable(length,start,delta,theFunction){
	table=new Array(length);
	for (var i = 0;i<length;i++){
		table[i]=theFunction(start+i*delta);
	}
	return table;
}

// the sine (and cosine) function
//======================================================================

var PIHALF=Math.PI*0.5;

var sinTab=[];
var sinTabLengthM1=0;
var sinTabFactor=1;
var sinTabHigherCorrection=0;
var sinTabLengthHalf=0;
var sinTabLengthQuarter=0;

function setupSinCosTable(p) {
	var sinTabLength=powerOf2(p);
 	sinTabLengthM1=sinTabLength-1;
 	sinTabLengthHalf=sinTabLength/2;
 	sinTabLengthQuarter=sinTabLength/4;
    sinTabFactor = 0.5*sinTabLength/Math.PI;
    sinTabHigherCorrection=0.25/sinTabFactor/sinTabFactor;
    sinTab=makeFunctionTable(sinTabLength+1,0,1.0/sinTabFactor,Math.sin);
}

//  the sine function
//------------------------------------------------

// looking up the nearest table value
function fastSin(x){
	return sinTab[Math.round(x*sinTabFactor)&sinTabLengthM1];
}
function fastSinModulus(x){
	return sinTab[Math.round(x*sinTabFactor)%sinTabLengthM1];
}

//  using linear interpolation
function fastInterpolatedSin(x){
	x*=sinTabFactor;
	var index=Math.floor(x);
	var dx=x-index;
	index=index&sinTabLengthM1;
	return sinTab[index]*(1-dx)+sinTab[index+1]*dx;
}

//  using the "quadratic" interpolation
function fastImprovedInterpolatedSin(x){
	x*=sinTabFactor;
	var index=Math.floor(x);
	var dx=x-index;
	index=index&sinTabLengthM1;
	return sinTab[index]*(1-dx)*(1+sinTabHigherCorrection*dx)+sinTab[index+1]*dx*(1+sinTabHigherCorrection*(1-dx));
}

// the cosine function
//----------------------------------------------------------------------

// looking up the nearest table value
function fastCos(x){
	return sinTab[Math.round((x+PIHALF)*sinTabFactor)&sinTabLengthM1];
}

//  using linear interpolation
function fastInterpolatedCos(x){
	x=sinTabFactor*(x+PIHALF);
	var index=Math.floor(x);
	var dx=x-index;
	index=index&sinTabLengthM1;
	return sinTab[index]*(1-dx)+sinTab[index+1]*dx;
}

//  using the "quadratic" interpolation
function fastImprovedInterpolatedCos(x){
	x=sinTabFactor*(x+PIHALF);
	var index=Math.floor(x);
	var dx=x-index;
	index=index&sinTabLengthM1;
	return sinTab[index]*(1-dx)*(1+sinTabHigherCorrection*dx)+sinTab[index+1]*dx*(1+sinTabHigherCorrection*(1-dx));
}

console.log(-10%4);
// using a table of 4097 elements
//==============================================

setupSinCosTable(12);

// checking the error of approximations
//=============================================================

console.log("fast sinus approximation error: ");
errorCheck(-20,20,0.01,Math.sin,fastSin);

console.log("interpolated sinus approximation error: ");
errorCheck(-10,20,0.01,Math.sin,fastInterpolatedSin);

console.log("improved interpolated sinus approximation error: ");
errorCheck(-10,20,0.01,Math.sin,fastImprovedInterpolatedSin);

console.log("cosinus approximation error: ");
errorCheck(-10,20,0.01,Math.cos,fastCos);

// checking the speed
//===================================================0

nChecks=100000000;

var x=0;
var y=0;
var range=63;
var dx=range/nChecks;
var start=0;
x=0;
start=time();
/*
while(x<range){
	y=Math.sin(x);
	x+=dx;
}
console.log("using the sin function: "+(time()-start)/1000);
*/
x=0;
start=time();
while(x<range){
	y=fastImprovedInterpolatedSin(x);
	x+=dx;
}
console.log("using the 'quadratic' interpolated sin function: "+(time()-start)/1000);

x=0;
start=time();
while(x<range){
	y=fastInterpolatedSin(x);
	x+=dx;
}
console.log("using the fast interpolated sin function: "+(time()-start)/1000);

x=0;
start=time();
while(x<range){
	y=fastSin(x);

	x+=dx;
}
console.log("using the fast sin function: "+(time()-start)/1000);

x=0;
start=time();
while(x<range){
	y=fastSinModulus(x);

	x+=dx;
}
console.log("using the modulus fast sin function: "+(time()-start)/1000);

//  for reference - the empty loop
x=0;
start=time();
while(x<range){
	x+=dx;
}
console.log("the empty loop: "+(time()-start)/1000);//  for reference - the empty loop

x=0;
start=time();
for (var i=nChecks;i>0;i--){
	x+=dx;
}
console.log("the empty for loop: "+(time()-start)/1000);

</script>
</html>
